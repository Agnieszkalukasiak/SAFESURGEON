{% extends 'base.html' %}
{% load static %}

{% block title %}Get Verified - SafeSurgeon{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-4">Submit Your Profile for Verification</h1>
    
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" id="verification-form">
        {% csrf_token %}
        
        <h2>Personal Information</h2>
        {{ form.non_field_errors }}
        <div class="mb-3">
            {{ form.first_name.label_tag }}
            {{ form.first_name }}
            {{ form.first_name.errors }}
        </div>
        <div class="mb-3">
            {{ form.last_name.label_tag }}
            {{ form.last_name }}
            {{ form.last_name.errors }}
        </div>
        <div class="mb-3">
            {{ form.email.label_tag }}
            {{ form.email }}
            {{ form.email.errors }}
        </div>
        <div class="mb-3">
            {{ form.profile_picture.label_tag }}
            {{ form.profile_picture }}
            {{ form.profile_picture.errors }}
        </div>
        
        <h2>Location</h2>
        <div class="mb-3">
            {{ form.country.label_tag }}
            {{ form.country }}
            {{ form.country.errors }}
        </div>
        <div class="mb-3">
            {{ form.city.label_tag }}
            {{ form.city }}         
            {{ form.city.errors }}
        </div>
        <div class="mb-3">
            <h2>Clinics</h2>
            <div id="clinic-management-form">
                {{clinic_formset.management_form}}
            </div>
            <div id="clinic-forms">
                {%for clinic_form in clinic_formset%}
                <div class="clinic_form mb-4" id="clinic-form-{{forloop.counter0}}">
                    <h3>Clinic Entry{{forloop.counter}}</h3>
                    {{clinic_form.non_field_errors}}
                    <div class="mb-3">
                    {{ clinic_form.clinic.label_tag }}
                    {{ clinic_form.clinic }}
                    {{ clinic_form.clinic.errors }}
                </div>
                <!-- new clinic -->
                <div class="mb-3">
                    {{ clinic_form.new_clinic_name.label_tag }}  
                    {{ clinic_form.new_clinic_name }}  
                    {{ clinic_form.new_clinic_name.errors }}
                </div>
    
                {% if clinic_formset.can_delete %}
                <div class="mb-3">
                    {{ clinic_form.DELETE.label_tag }}
                    {{ clinic_form.DELETE }}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        <button type="button" id="add-clinic" class="btn btn-secondary mb-3">Add Another Clinic</button>
    </div>
               
        <h2>Education</h2>
        {{ education_formset.management_form }}
        <div id="education-forms">
            {% for education_form in education_formset %}
                <div class="education-form mb-4">
                    <h3>Education Entry {{ forloop.counter }}</h3>
                    {{ education_form.non_field_errors }}
                    <div class="mb-3">
                        {{ education_form.institution.label_tag }}
                        {{ education_form.institution }}
                        {{ education_form.institution.errors }}
                    </div>
                    <div class="mb-3">
                        {{ education_form.program.label_tag }}
                        {{ education_form.program }}
                        {{ education_form.program.errors }}
                    </div>
                    <div class="mb-3">
                        {{ education_form.country.label_tag }}
                        {{ education_form.country }}
                        {{ education_form.country.errors }}
                    </div>
                    <div class="mb-3">
                        {{ education_form.start_date.label_tag }}
                        {{ education_form.start_date }}
                        {{ education_form.start_date.errors }}
                    </div>
                    <div class="mb-3">
                        {{ education_form.end_date.label_tag }}
                        {{ education_form.end_date }}
                        {{ education_form.end_date.errors }}
                    </div>
                    <div class="mb-3">
                        {{ education_form.certificate.label_tag }}
                        {{ education_form.certificate }}
                        {{ education_form.certificate.errors }}
                    </div>
                    {% if education_formset.can_delete %}
                        <div class="mb-3">
                            {{ education_form.DELETE.label_tag }}
                            {{ education_form.DELETE }}
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
        <button type="button" id="add-education" class="btn btn-secondary mb-3">Add Another Education Entry</button>
        <div class="mb-3">
            {{ form.id_document.label_tag }}
            {{ form.id_document }}
            {{ form.id_document.errors }}
        </div>
        
        <div class="mb-3">
            <button type="submit" class="btn btn-primary">Submit for Verification</button>
                <div id="thankYouMessage" style="display: none;">
                    Thank you for your submission. We will email you once your verification process is completed. Thank you!
            </div>
        </div>      
    </form>
{% if form.errors %}
<div class="alert alert-danger">
    <ul>
    {% for field, errors in form.errors.items %}
        <li>{{ field }}: {{ errors }}</li>
    {% endfor %}
    </ul>
</div>
{% endif %}


<script>
    console.log("Inline script running");
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM loaded from inline script");
        const addClinicButton = document.getElementById('add-clinic');
        const clinicFormsContainer = document.getElementById('clinic-forms');
        const managementForm = document.querySelector('input[name$=TOTAL_FORMS]');
    
        console.log("Add Clinic button:", addClinicButton);
        console.log("Clinic Forms Container:", clinicFormsContainer);
        console.log("Management Form:", managementForm);
    
        if (addClinicButton && clinicFormsContainer && managementForm) {
            addClinicButton.addEventListener('click', function() {
                console.log("Add Clinic button clicked");
                alert("Add Clinic button clicked!");
    
                let formCount = parseInt(managementForm.value);
                console.log("Current form count:", formCount);
    
                if (clinicFormsContainer.children.length > 0) {
                    const lastForm = clinicFormsContainer.children[clinicFormsContainer.children.length - 1];
                    const newForm = lastForm.cloneNode(true);
                    console.log("New form cloned");
    
                    newForm.innerHTML = newForm.innerHTML.replace(/clinic_set-\d+/g, `clinic_set-${formCount}`);
                    newForm.innerHTML = newForm.innerHTML.replace(/-\d+-/g, `-${formCount}-`);
                    console.log("Form index updated");
    
                    newForm.querySelectorAll('input:not([type=hidden]), select').forEach(input => {
                        input.value = '';
                    });
                    console.log("Input values cleared");
    
                    formCount++;
                    managementForm.value = formCount;
                    console.log("Total forms updated to:", managementForm.value);
    
                    clinicFormsContainer.appendChild(newForm);
                    console.log("New form appended");
                } else {
                    console.error("No existing clinic forms to clone");
                }
            });
        } else {
            console.error("Required elements not found");
            console.log("Add Clinic button:", addClinicButton);
            console.log("Clinic Forms Container:", clinicFormsContainer);
            console.log("Management Form:", managementForm);
        }
    });
    </script>
{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/clinic_form.js' %}"></script>
    <script src="{% static 'js/clinic_add_button.js' %}"></script>
    <script>
        //  base URL for AJAX calls
        var baseUrl = "{% url 'get_cities' 0 %}".slice(0, -2);  
    </script>
{% endblock %}
