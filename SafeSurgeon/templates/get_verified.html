{% extends 'base.html' %}
{% load static %}


{% block title %}Get Verified - SafeSurgeon{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-4">Submit Your Profile for Verification</h1>
    
    {% if messages %}
    <div class="messages mb-4">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" id="verification-form">
        {% csrf_token %}

        {% if form.non_field_errors %}
        <div class="alert alert-danger">
            {{ form.non_field_errors }}
        </div>
        {% endif %}

        <div class="card mb-4">
            <div class="card-header">
                <h2 class="mb-0">Personal Information</h2>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p class="form-control-static">{{ request.user.first_name }} {{ request.user.last_name }}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="form-control-static">{{ request.user.email }}</p>
                    </div>
                </div>
                <div class="mb-3">
                    {{ form.profile_picture.label_tag }}
                    {{ form.profile_picture }}
                    {{ form.profile_picture.errors }}
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h2 class="mb-0">Location</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ form.country.label_tag }}
                        {{ form.country }}
                        {{ form.country.errors }}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.city.label_tag }}
                        {{ form.city }}
                        {{ form.city.errors }}
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h2 class="mb-0">Add Clinics</h2>
            </div>
            <div class="card-body">
                {{ clinic_formset.non_field_errors }}
                <div id="clinic-management-form">
                    {{clinic_formset.management_form}}
                </div>
                <div id="clinic-forms">
                    {% for clinic_form in clinic_formset %}
                    <div class="clinic_form mb-3" id="clinic-form-{{forloop.counter0}}">
                        {{ clinic_form.non_field_errors }}
                        <div class="row">
                            <div class="col-md-6 mb-3">                     
                                {{ clinic_form.clinic.label_tag }}
                                {{ clinic_form.clinic }}
                                {{ clinic_form.clinic.errors }}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ clinic_form.new_clinic_name.label_tag }}  
                                {{ clinic_form.new_clinic_name }}  
                                {{ clinic_form.new_clinic_name.errors }}
                            </div>
                            <hr>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" id="add-clinic" class="btn btn-secondary">Add Another Clinic</button>
            </div>
        </div>

        <div class="card mb-4"> 
            <div class="card-header">
                <h2 class="mb-0">Add Education</h2>
            </div>
            <div class="card-body">
                {{ education_formset.non_field_errors }}
                <div id="education-management-form">
                    {{ education_formset.management_form }}
                </div>
                <div id="education-forms"> 
                    {% for education_form in education_formset %}
                    <div class="education-form mb-4">
                        {{ education_form.non_field_errors }}
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ education_form.institution.label_tag }}
                                {{ education_form.institution }}
                                {{ education_form.institution.errors }}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ education_form.institution_country.label_tag }}
                                {{ education_form.institution_country }}
                                {{ education_form.institution_country.errors }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ education_form.program.label_tag }}
                                {{ education_form.program }}
                                {{ education_form.program.errors }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ education_form.start_date.label_tag }}
                                {{ education_form.start_date }}
                                {{ education_form.start_date.errors }}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ education_form.end_date.label_tag }}
                                {{ education_form.end_date }}
                                {{ education_form.end_date.errors }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                {{ education_form.certificate.label_tag }}
                                {{ education_form.certificate }}
                                {{ education_form.certificate.errors }}
                                
                            </div>
                            <hr>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" id="add-education" class="btn btn-secondary">Add Another Education Entry</button>
        </div>
    </div>

        <div class="card mb-4">
            <div class="card-header">
                <h2 class="mb-0">Identification</h2>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    {{ form.id_document.label_tag }}
                    {{ form.id_document }}
                    {{ form.id_document.errors }}
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body text-center">
                <button type="submit" class="btn btn-primary btn-lg">Submit for Verification</button>
            </div>
        </div>
    </form>

    {% if form.errors %}
    <div class="alert alert-danger">
        <ul>
        {% for field, errors in form.errors.items %}
            <li>{{ field }}: {{ errors }}</li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const citySelect = document.querySelector('select[name="city"]');
    const clinicSelects = document.querySelectorAll('select[name$="-clinic"]');
    const newClinicInputs = document.querySelectorAll('input[name$="-new_clinic_name"]');
    const clinicUrl = window.clinicUrl;

    function saveClinicSelections() {
        const selections = {};
        clinicSelects.forEach((select, index) => {
            selections[index] = {
                clinic: select.value,
                new_clinic: newClinicInputs[index].value
            };
        });
        localStorage.setItem('clinicSelections', JSON.stringify(selections));
    }

    function loadClinicSelections() {
        const savedSelections = JSON.parse(localStorage.getItem('clinicSelections') || '{}');
        clinicSelects.forEach((select, index) => {
            if (savedSelections[index]) {
                if (savedSelections[index].clinic && select.querySelector(`option[value="${savedSelections[index].clinic}"]`)) {
                    select.value = savedSelections[index].clinic;
                }
                if (savedSelections[index].new_clinic) {
                    newClinicInputs[index].value = savedSelections[index].new_clinic;
                }
            }
        });
    }

    citySelect.addEventListener('change', function() {
        const cityId = this.value;
        if (cityId) {
            fetch(`${clinicUrl}${cityId}`)
                .then(response => response.json())
                .then(data => {
                    clinicSelects.forEach(clinicSelect => {
                        clinicSelect.innerHTML = '<option value="">---------</option>';
                        data.clinics.forEach(clinic => {
                            const option = new Option(clinic.name, clinic.id);
                            clinicSelect.add(option);
                        });
                    });
                });
        } else {
            clinicSelects.forEach(clinicSelect => {
                clinicSelect.innerHTML = '<option value="">---------</option>';
            });
        }
    });

    // Load saved selections when the page loads
    loadClinicSelections();

    // Save selections when the form is submitted
    document.querySelector('form').addEventListener('submit', saveClinicSelections);
});

document.addEventListener('DOMContentLoaded', function() {
    const addButton = document.getElementById('add-education');
    if (addButton) {
        addButton.addEventListener('click', function() {
            // Wait a bit for the new form to be added to the DOM
            setTimeout(retrieveSecondFormData, 100);
        });
    }

    function retrieveSecondFormData() {
        const educationForms = document.querySelectorAll('[id^="education_set-"]');
        if (educationForms.length >= 2) {
            const secondForm = educationForms[1];
            const formData = new FormData(secondForm);
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            console.log('Second Education Form Data:', data);
        } else {
            console.log('Second education form not found');
        }
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const addEducationButton = document.getElementById('add-education');
    const educationForms = document.getElementById('education-forms');
    const totalFormsInput = document.querySelector('#id_education-TOTAL_FORMS');
    
    if (addEducationButton) {
        addEducationButton.addEventListener('click', function() {
            const formCount = educationForms.children.length;
            const newForm = educationForms.children[0].cloneNode(true);
            
            newForm.innerHTML = newForm.innerHTML.replace(/-\d+-/g, `-${formCount}-`);
            newForm.querySelectorAll('input, select').forEach(input => {
                input.value = '';
                input.id = input.id.replace(/-\d+-/, `-${formCount}-`);
                input.name = input.name.replace(/-\d+-/, `-${formCount}-`);
            });
            
            educationForms.appendChild(newForm);
            totalFormsInput.value = formCount + 1;
        });
    }
});

</script>

{% endblock %}


{% block extra_js %}
    <script src="{% static 'js/clinic_form.js' %}"></script>
    <script src="{% static 'js/clinic_add_button.js' %}"></script>
    <script src="{% static 'js/education_add_button.js' %}"></script>
    <script>
        window.cityUrl = "{% url 'get_cities' 0 %}".slice(0, -1);
    </script>
    <script>
        window.clinicUrl = "{% url 'get_clinics' 0 %}".slice(0, -1);
    </script>
    

{% endblock %}